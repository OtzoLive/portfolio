---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../config";

//import { webVitals } from "../pages/vitals";
const astroUrl = new URL(Astro.request.url);
console.log(astroUrl);
const analyticsId = import.meta.env.VERCEL_ANALYTICS_ID;
console.log(analyticsId);
const astroParams = Astro.params;

/*let analyticsId = import.meta.env.VERCEL_ANALYTICS_ID;
//https://www.npmjs.com/package/web-vitals#load-web-vitals-from-a-cdn
webVitals({
    path: new URL(Astro.request.url),
    params: Astro.params,
    analyticsId,
});*/
---

<!DOCTYPE html>
<html data-theme="wireframe" lang="en-us">
    <head>
        <script
            type="module"
            define:vars={{ astroUrl, analyticsId, astroParams }}
        >
            import pkg from "web-vitals";
            const { getFID, getTTFB, getLCP, getCLS, getFCP } = pkg;

            const vitalsUrl = "https://vitals.vercel-analytics.com/v1/vitals";

            function getConnectionSpeed() {
                return "connection" in navigator &&
                    navigator["connection"] &&
                    "effectiveType" in navigator["connection"]
                    ? navigator["connection"]["effectiveType"]
                    : "";
            }

            function sendToAnalytics(metric, options) {
                const page = Object.entries(options.params).reduce(
                    (acc, [key, value]) => acc.replace(value, `[${key}]`),
                    options.path
                );

                const body = {
                    dsn: options.analyticsId, // qPgJqYH9LQX5o31Ormk8iWhCxZO
                    id: metric.id, // v2-1653884975443-1839479248192
                    page, // /blog/[slug]
                    href: location.href, // https://my-app.vercel.app/blog/my-test
                    event_name: metric.name, // TTFB
                    value: metric.value.toString(), // 60.20000000298023
                    speed: getConnectionSpeed(), // 4g
                };

                if (options.debug) {
                    console.log(
                        "[Analytics]",
                        metric.name,
                        JSON.stringify(body, null, 2)
                    );
                }

                const blob = new Blob([new URLSearchParams(body).toString()], {
                    // This content type is necessary for `sendBeacon`
                    type: "application/x-www-form-urlencoded",
                });
                if (navigator.sendBeacon) {
                    navigator.sendBeacon(vitalsUrl, blob);
                } else
                    fetch(vitalsUrl, {
                        body: blob,
                        method: "POST",
                        credentials: "omit",
                        keepalive: true,
                    });
            }

            export function webVitals(options) {
                try {
                    getFID((metric) => sendToAnalytics(metric, options));
                    getTTFB((metric) => sendToAnalytics(metric, options));
                    getLCP((metric) => sendToAnalytics(metric, options));
                    getCLS((metric) => sendToAnalytics(metric, options));
                    getFCP((metric) => sendToAnalytics(metric, options));
                } catch (err) {
                    console.error("[Analytics]", err);
                }
            }

            console.log(astroUrl, astroParams);

            webVitals({
                path: astroUrl,
                params: astroParams,
                analyticsId,
            });
        </script>
        <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    </head>

    <body class="flex flex-col min-h-screen">
        <Header title={SITE_TITLE} />
        <main class="flex-auto">
            <slot /><!-- Body Stuff goes here -->
        </main>
        <Footer />
    </body>
</html>
